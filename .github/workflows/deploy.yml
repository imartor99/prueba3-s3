name: CI/CD - Despliegue de Lista de Libros

on:
  push:
    branches:
      - develop # El workflow se activa con cada push a la rama develop

jobs:
  test:
    name: üß™ Pruebas Unitarias (CI)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Instalar dependencias (npm ci)
        # Instala dependencias (Jest y JSDoc)
        run: npm ci

      - name: Ejecutar unit tests
        # Ejecuta el script 'test' que configuramos para Jest
        run: npm test

  docs:
    name: üìù Generar Documentaci√≥n (JSDoc)
    runs-on: ubuntu-latest
    needs: test # Solo se ejecuta si las pruebas unitarias pasan

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Instalar dependencias (npm ci)
        # Necesitamos instalar dependencias de nuevo en este runner
        run: npm ci

      - name: Generar JSDoc documentation
        # Llama al script 'docs' en package.json (asumiendo que es: "docs": "jsdoc -c jsdoc.json" o similar)
        run: npm run docs

      # Opcional: Si quieres guardar la documentaci√≥n generada como un artefacto:
      #- name: Upload Documentation Artifact
      #  uses: actions/upload-artifact@v4
      #  with:
      #    name: jsdoc-html-docs
      #    path: docs/ # Asume que jsdoc genera archivos en una carpeta llamada 'docs'

  deploy:
    name: üöÄ Despliegue a S3 (CD)
    runs-on: ubuntu-latest
    needs: [test, docs]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- 1. CONFIGURACI√ìN DE CREDENCIALES AWS ---
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }} # Ej: us-east-1 o eu-west-1
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}

      # --- 2. DESPLIEGUE A S3 ---
      - name: Deploy static files to S3
        run: |
          aws s3 sync . s3://prueba3-s3-examen-practica/ \
            --delete \
            --exclude ".git/*" \
            --exclude "node_modules/*" \
            --exclude ".github/*"
