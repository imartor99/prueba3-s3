name: CI/CD - Despliegue de Lista de Libros

on:
  push:
    branches:
      - develop # El workflow se activa con cada push a la rama develop

jobs:
  test:
    name: 游빍 Pruebas Unitarias (CI)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Instalar dependencias (npm ci)
        # Instala dependencias (Jest y JSDoc)
        run: npm ci

      - name: Ejecutar unit tests
        # Ejecuta el script 'test' que configuramos para Jest
        run: npm test

  docs:
    name: 游닇 Generar Documentaci칩n (JSDoc)
    runs-on: ubuntu-latest
    needs: test # Solo se ejecuta si las pruebas unitarias pasan

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Instalar dependencias (npm ci)
        # Necesitamos instalar dependencias de nuevo en este runner
        run: npm ci

      - name: Generar JSDoc documentation
        # Llama al script 'docs' en package.json (asumiendo que es: "docs": "jsdoc -c jsdoc.json" o similar)
        run: npm run docs

      # Opcional: Si quieres guardar la documentaci칩n generada como un artefacto:
      - name: Upload Documentation Artifact
        uses: actions/upload-artifact@v4
        with:
          name: jsdoc-documentation
          path: docs/ # Asume que jsdoc genera archivos en una carpeta llamada 'docs'

  deploy:
    name: 游 Despliegue a S3 (CD)
    runs-on: ubuntu-latest
    needs: [test, docs]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- PASO CR칈TICO: Descargar la carpeta docs/ al nuevo runner ---
      - name: Descargar documentaci칩n al nuevo runner
        uses: actions/download-artifact@v4
        with:
          name: jsdoc-documentation
          path: ./docs

      # --- 1. CONFIGURACI칍N DE CREDENCIALES AWS ---
      - name: Configurar credenciales AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }} # Ej: us-east-1 o eu-west-1
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}

      # --- 2. DESPLIEGUE A S3 ---
      - name: Despliegue de archivos est치ticos a S3
        run: |
          aws s3 sync . s3://prueba3.nachodaw.com/ \
            --delete \
            --exclude ".git/*" \
            --exclude "node_modules/*" \
            --exclude ".github/*" \
            --exclude ".gitignore"
